<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00ff88">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ZERO TIME">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <title>ZERO TIME Config</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #444;
        }
        
        .header h1 {
            color: #00ff88;
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0,255,136,0.5);
        }
        
        .status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .status.disconnected {
            background: #ff4444;
            color: white;
        }
        
        .status.connected {
            background: #00ff88;
            color: #1a1a1a;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background: #00ff88;
            color: #1a1a1a;
        }
        
        .btn-primary:hover {
            background: #00dd77;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,255,136,0.4);
        }
        
        .btn-primary:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }
        
        .settings-group {
            margin-bottom: 25px;
            padding: 20px;
            background: #333;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
        }
        
        .settings-group h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .setting-item {
            margin-bottom: 15px;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 8px;
            color: #bbb;
            font-size: 0.95em;
        }
        
        .setting-item input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #555;
            outline: none;
            -webkit-appearance: none;
        }
        
        .setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00ff88;
            cursor: pointer;
        }
        
        .setting-item input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00ff88;
            cursor: pointer;
            border: none;
        }
        
        .value-display {
            display: inline-block;
            float: right;
            background: #00ff88;
            color: #1a1a1a;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 30px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #00ff88;
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .info-box {
            background: #1a3a2a;
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #aaa;
        }
        
        .info-box strong {
            color: #00ff88;
        }

        .install-prompt {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            color: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }

        .install-prompt.show {
            display: block;
        }

        .logo-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo-header img {
            max-width: 200px;
            height: auto;
        }

        .brightness-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .brightness-btn {
            padding: 12px 8px;
            border: 2px solid #555;
            background: #2a2a2a;
            color: #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
        }

        .brightness-btn:hover {
            border-color: #00ff88;
            background: #333;
        }

        .brightness-btn.active {
            background: #00ff88;
            color: #1a1a1a;
            border-color: #00ff88;
        }

        .brightness-hint {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #444;
        }

        .nav-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            color: #00ff88;
        }

        .nav-tab.active {
            color: #00ff88;
            border-bottom-color: #00ff88;
        }

        .position-card, .shot-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .position-header, .shot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .position-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #00ff88;
        }

        .shot-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .shot-data {
            text-align: center;
            padding: 8px;
            background: #333;
            border-radius: 5px;
        }

        .shot-label {
            font-size: 0.8em;
            color: #888;
        }

        .shot-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #00ff88;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #bbb;
            font-size: 0.9em;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 1em;
        }

        .btn-secondary {
            background: #555;
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: #666;
        }

        .btn-danger {
            background: #ff4444;
            color: white;
        }

        .btn-danger:hover {
            background: #cc3333;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            width: auto;
            display: inline-block;
            margin-right: 10px;
        }

        .drill-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .drill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .drill-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #00ff88;
        }

        .drill-info {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
        }

        .drill-actions {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="install-prompt" id="installPrompt">
        üì± Installa ZERO TIME come app sul tuo dispositivo!
    </div>

    <div class="container">
        <div class="logo-header">
            <img src="./shooting-labs-logo.jpg" alt="Shooting Labs">
        </div>

        <div class="header">
            <h1>‚è±Ô∏è ZERO TIME</h1>
            <div class="status disconnected" id="statusIndicator">‚óè Disconnesso</div>
        </div>

        <button class="btn btn-primary" id="connectBtn">üîµ Connetti Bluetooth (DEBUG MODE)</button>

        <div id="debugLog" style="background: #1a1a1a; border: 2px solid #00ff88; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-family: monospace; font-size: 0.85em; max-height: 200px; overflow-y: auto; display: none;">
            <div style="color: #00ff88; font-weight: bold; margin-bottom: 10px;">üîç DEBUG LOG:</div>
            <div id="debugMessages" style="color: #e0e0e0;"></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('config')">‚öôÔ∏è Config</button>
            <button class="nav-tab" onclick="switchTab('profiles')">üë§ Profili</button>
            <button class="nav-tab" onclick="switchTab('drills')">üéØ Esercizi</button>
        </div>

        <!-- SEZIONE CONFIGURAZIONE -->
        <div id="configSection" class="section active">
            <div class="settings-group">
                <h3>üí° Luminosit√† Display</h3>
                <div class="brightness-buttons">
                    <button class="brightness-btn" onclick="setBrightness(1)">
                        1<br>
                        <span class="brightness-hint">Molto bassa</span>
                    </button>
                    <button class="brightness-btn" onclick="setBrightness(2)">
                        2<br>
                        <span class="brightness-hint">Bassa</span>
                    </button>
                    <button class="brightness-btn active" onclick="setBrightness(3)">
                        3<br>
                        <span class="brightness-hint">Media</span>
                    </button>
                    <button class="brightness-btn" onclick="setBrightness(4)">
                        4<br>
                        <span class="brightness-hint">Alta</span>
                    </button>
                    <button class="brightness-btn" onclick="setBrightness(5)">
                        5<br>
                        <span class="brightness-hint">Molto alta</span>
                    </button>
                </div>
            </div>

            <div class="settings-group">
                <h3>‚è±Ô∏è Timer</h3>
                <div class="setting-item">
                    <label>Soglia Beep <span class="value-display" id="beepThresholdValue">2000</span></label>
                    <input type="range" id="beepThreshold" min="500" max="5000" value="2000" step="100">
                </div>
                <div class="setting-item">
                    <label>Soglia Colpo <span class="value-display" id="shotThresholdValue">5000</span></label>
                    <input type="range" id="shotThreshold" min="2000" max="10000" value="5000" step="100">
                </div>
            </div>

            <div class="info-box">
                <strong>‚ÑπÔ∏è Istruzioni:</strong><br>
                1. Click "Connetti Bluetooth" per cercare ZERO TIME<br>
                2. Seleziona il dispositivo dalla lista<br>
                3. Regola le impostazioni come preferisci<br>
                4. Le modifiche vengono inviate automaticamente al dispositivo
            </div>
        </div>

        <!-- SEZIONE PROFILI -->
        <div id="profilesSection" class="section">
            <button class="btn btn-primary" onclick="newProfile()">‚ûï Nuovo Profilo</button>
            <div id="profileList"></div>

            <div id="profileEditor" style="display:none;">
                <h3>Modifica Profilo</h3>
                <div class="input-group">
                    <label>Nome Profilo</label>
                    <input type="text" id="profileName" placeholder="es. 6.5 Creedmoor">
                </div>
                <div class="input-group">
                    <label>Unit√†</label>
                    <select id="profileUnit">
                        <option value="MIL">MIL</option>
                        <option value="MOA">MOA</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="saveProfile()">üíæ Salva Profilo</button>
                <button class="btn btn-secondary" onclick="cancelProfileEdit()">‚ùå Annulla</button>
            </div>
        </div>

        <!-- SEZIONE ESERCIZI -->
        <div id="drillsSection" class="section">
            <button class="btn btn-primary" onclick="newDrill()">‚ûï Nuovo Esercizio</button>
            <div id="drillList"></div>

            <div id="drillEditor" style="display:none;">
                <h3>Crea Esercizio</h3>
                <div class="input-group">
                    <label>Nome Esercizio</label>
                    <input type="text" id="drillName" placeholder="es. Stage 1 - Campo Dinamico">
                </div>
                <div class="input-group">
                    <label>Profilo Balistico</label>
                    <select id="drillProfile"></select>
                </div>

                <h4>Posizioni</h4>
                <div id="positionsList"></div>
                <button class="btn btn-secondary btn-small" onclick="addPosition()">‚ûï Aggiungi Posizione</button>
                <button class="btn btn-primary btn-small" onclick="previewDrill()" id="previewDrillBtn">üëÅÔ∏è Anteprima</button>

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveDrill()">üíæ Salva Esercizio</button>
                    <button class="btn btn-secondary" onclick="cancelDrillEdit()">‚ùå Annulla</button>
                </div>
            </div>

            <h4 style="margin-top: 30px;">Backup & Export</h4>
            <button class="btn btn-secondary" onclick="exportBackup()" id="exportBackupBtn">üì§ Esporta Backup</button>
            <button class="btn btn-secondary" onclick="importBackup()" id="importBackupBtn">üì• Importa Backup</button>
            <input type="file" id="importFile" accept=".json" style="display:none;">
        </div>
    </div>

    <script>
        // ==========================================
        // BLUETOOTH CONNECTION
        // ==========================================
        
        let device = null;
        let characteristic = null;
        let notifyCharacteristic = null;
        const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
        const WRITE_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef1';
        const NOTIFY_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef2';

        // Funzione per log debug visibile
        function debugLog(message) {
            console.log(message);
            const debugArea = document.getElementById('debugLog');
            const debugMessages = document.getElementById('debugMessages');
            debugArea.style.display = 'block';
            const time = new Date().toLocaleTimeString();
            debugMessages.innerHTML += `<div>[${time}] ${message}</div>`;
            debugMessages.scrollTop = debugMessages.scrollHeight;
        }

        document.getElementById('connectBtn').onclick = async () => {
            try {
                debugLog('üîç Ricerca dispositivo Bluetooth...');
                debugLog('üîß DEBUG MODE: Mostra TUTTI i dispositivi BLE');
                debugLog('‚ö†Ô∏è Cerca "ZERO TIME" nella lista!');
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                debugLog('üì± Dispositivo selezionato: ' + device.name);
                debugLog('üÜî Device ID: ' + device.id);
                debugLog('üîå Connessione in corso...');

                const server = await device.gatt.connect();
                debugLog('‚úÖ Server GATT connesso');
                
                debugLog('üîç Ricerca Service UUID: ' + SERVICE_UUID);
                const service = await server.getPrimaryService(SERVICE_UUID);
                debugLog('‚úÖ Service trovato!');
                
                debugLog('üîç Ricerca caratteristica WRITE...');
                characteristic = await service.getCharacteristic(WRITE_CHAR_UUID);
                debugLog('‚úÖ Caratteristica WRITE trovata');
                
                debugLog('üîç Ricerca caratteristica NOTIFY...');
                notifyCharacteristic = await service.getCharacteristic(NOTIFY_CHAR_UUID);
                debugLog('‚úÖ Caratteristica NOTIFY trovata');

                await notifyCharacteristic.startNotifications();
                notifyCharacteristic.addEventListener('characteristicvaluechanged', handleNotification);

                document.getElementById('statusIndicator').className = 'status connected';
                document.getElementById('statusIndicator').textContent = '‚óè Connesso';
                document.getElementById('connectBtn').textContent = '‚úÖ Connesso a ' + device.name;
                document.getElementById('connectBtn').disabled = true;

                debugLog('‚úÖ‚úÖ‚úÖ CONNESSIONE STABILITA CON SUCCESSO! ‚úÖ‚úÖ‚úÖ');
            } catch (error) {
                debugLog('‚ùå ERRORE: ' + error.message);
                console.error('‚ùå Errore connessione:', error);
                alert('Errore di connessione: ' + error.message + '\n\nControlla il log DEBUG qui sotto per pi√π dettagli.');
            }
        };

        function handleNotification(event) {
            const value = new TextDecoder().decode(event.target.value);
            console.log('üì® Notifica ricevuta:', value);
        }

        async function sendCommand(command) {
            if (!characteristic) {
                alert('Connetti prima il dispositivo Bluetooth!');
                return false;
            }

            try {
                const encoder = new TextEncoder();
                await characteristic.writeValue(encoder.encode(command));
                console.log('üì§ Comando inviato:', command);
                return true;
            } catch (error) {
                console.error('‚ùå Errore invio comando:', error);
                return false;
            }
        }

        // ==========================================
        // BRIGHTNESS CONTROL
        // ==========================================
        
        async function setBrightness(level) {
            const buttons = document.querySelectorAll('.brightness-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.closest('.brightness-btn').classList.add('active');

            const command = `SET_BRIGHTNESS:${level}`;
            const success = await sendCommand(command);
            
            if (success) {
                console.log(`‚úÖ Luminosit√† applicata: ${level}`);
            }
        }

        // ==========================================
        // TIMER SETTINGS
        // ==========================================
        
        const beepThresholdSlider = document.getElementById('beepThreshold');
        const shotThresholdSlider = document.getElementById('shotThreshold');

        beepThresholdSlider.oninput = (e) => {
            document.getElementById('beepThresholdValue').textContent = e.target.value;
            sendCommand(`SET_BEEP_THRESHOLD:${e.target.value}`);
        };

        shotThresholdSlider.oninput = (e) => {
            document.getElementById('shotThresholdValue').textContent = e.target.value;
            sendCommand(`SET_SHOT_THRESHOLD:${e.target.value}`);
        };

        // ==========================================
        // NAVIGATION
        // ==========================================
        
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');
        }

        // ==========================================
        // STORAGE MANAGEMENT
        // ==========================================
        
        const Storage = {
            getProfiles: () => JSON.parse(localStorage.getItem('zt_profiles') || '[]'),
            saveProfiles: (data) => localStorage.setItem('zt_profiles', JSON.stringify(data)),
            getDrills: () => JSON.parse(localStorage.getItem('zt_drills') || '[]'),
            saveDrills: (data) => localStorage.setItem('zt_drills', JSON.stringify(data))
        };

        // ==========================================
        // PROFILES MANAGEMENT
        // ==========================================
        
        let profiles = Storage.getProfiles();
        let currentProfile = null;

        function loadProfileList() {
            const list = document.getElementById('profileList');
            list.innerHTML = '';

            if (profiles.length === 0) {
                list.innerHTML = '<p style="color: #888;">Nessun profilo salvato</p>';
                return;
            }

            profiles.forEach(profile => {
                const card = document.createElement('div');
                card.className = 'position-card';
                card.innerHTML = `
                    <div class="position-header">
                        <span class="position-title">${profile.nome}</span>
                        <div>
                            <button class="btn btn-small btn-secondary" onclick="editProfile('${profile.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="deleteProfile('${profile.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="color: #888;">Unit√†: ${profile.unita}</div>
                `;
                list.appendChild(card);
            });

            updateDrillProfileSelect();
        }

        function newProfile() {
            currentProfile = { id: Date.now().toString(), nome: '', unita: 'MIL' };
            document.getElementById('profileName').value = '';
            document.getElementById('profileUnit').value = 'MIL';
            document.getElementById('profileEditor').style.display = 'block';
        }

        function editProfile(id) {
            currentProfile = profiles.find(p => p.id === id);
            document.getElementById('profileName').value = currentProfile.nome;
            document.getElementById('profileUnit').value = currentProfile.unita;
            document.getElementById('profileEditor').style.display = 'block';
        }

        function saveProfile() {
            const nome = document.getElementById('profileName').value.trim();
            if (!nome) {
                alert('Inserisci un nome per il profilo!');
                return;
            }

            currentProfile.nome = nome;
            currentProfile.unita = document.getElementById('profileUnit').value;

            const index = profiles.findIndex(p => p.id === currentProfile.id);
            if (index >= 0) {
                profiles[index] = currentProfile;
            } else {
                profiles.push(currentProfile);
            }

            Storage.saveProfiles(profiles);
            loadProfileList();
            cancelProfileEdit();
        }

        function deleteProfile(id) {
            if (!confirm('Eliminare questo profilo?')) return;
            profiles = profiles.filter(p => p.id !== id);
            Storage.saveProfiles(profiles);
            loadProfileList();
        }

        function cancelProfileEdit() {
            document.getElementById('profileEditor').style.display = 'none';
            currentProfile = null;
        }

        // ==========================================
        // DRILLS MANAGEMENT
        // ==========================================
        
        let drills = Storage.getDrills();
        let currentDrill = null;

        function updateDrillProfileSelect() {
            const select = document.getElementById('drillProfile');
            select.innerHTML = '<option value="">Seleziona profilo</option>';
            profiles.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
            });
        }

        function loadSavedDrills() {
            const list = document.getElementById('drillList');
            list.innerHTML = '';

            if (drills.length === 0) {
                list.innerHTML = '<p style="color: #888;">Nessun esercizio salvato</p>';
                return;
            }

            drills.forEach(drill => {
                const profile = profiles.find(p => p.id === drill.profilo);
                const card = document.createElement('div');
                card.className = 'drill-card';
                card.innerHTML = `
                    <div class="drill-header">
                        <span class="drill-title">${drill.nome}</span>
                    </div>
                    <div class="drill-info">
                        Profilo: ${profile ? profile.nome : 'N/A'}<br>
                        Posizioni: ${drill.posizioni.length}
                    </div>
                    <div class="drill-actions">
                        <button class="btn btn-small btn-secondary" onclick="editDrill('${drill.id}')">‚úèÔ∏è Modifica</button>
                        <button class="btn btn-small btn-primary" onclick="sendDrill('${drill.id}')">üì§ Invia</button>
                        <button class="btn btn-small btn-secondary" onclick="exportDrill('${drill.id}')">üíæ Export</button>
                        <button class="btn btn-small btn-secondary" onclick="exportDrillImage('${drill.id}')">üì∏ PNG</button>
                        <button class="btn btn-small btn-danger" onclick="deleteDrill('${drill.id}')">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function newDrill() {
            currentDrill = {
                id: Date.now().toString(),
                nome: '',
                profilo: '',
                posizioni: []
            };
            document.getElementById('drillName').value = '';
            document.getElementById('drillProfile').value = '';
            document.getElementById('positionsList').innerHTML = '';
            document.getElementById('drillEditor').style.display = 'block';
        }

        function editDrill(id) {
            currentDrill = JSON.parse(JSON.stringify(drills.find(d => d.id === id)));
            document.getElementById('drillName').value = currentDrill.nome;
            document.getElementById('drillProfile').value = currentDrill.profilo;
            renderPositions();
            document.getElementById('drillEditor').style.display = 'block';
        }

        function addPosition() {
            const nome = prompt('Nome posizione:', `Posizione ${currentDrill.posizioni.length + 1}`);
            if (!nome) return;

            currentDrill.posizioni.push({
                nome: nome,
                colpi: []
            });
            renderPositions();
        }

        function renderPositions() {
            const list = document.getElementById('positionsList');
            list.innerHTML = '';

            currentDrill.posizioni.forEach((pos, posIdx) => {
                const card = document.createElement('div');
                card.className = 'position-card';
                card.innerHTML = `
                    <div class="position-header">
                        <span class="position-title">${pos.nome}</span>
                        <div>
                            <button class="btn btn-small btn-secondary" onclick="addShot(${posIdx})">‚ûï Colpo</button>
                            <button class="btn btn-small btn-danger" onclick="deletePosition(${posIdx})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div id="shots-${posIdx}"></div>
                `;
                list.appendChild(card);

                const shotsDiv = document.getElementById(`shots-${posIdx}`);
                pos.colpi.forEach((colpo, shotIdx) => {
                    const shotCard = document.createElement('div');
                    shotCard.className = 'shot-card';
                    shotCard.innerHTML = `
                        <div class="shot-header">
                            <span>Colpo #${colpo.n}</span>
                            <button class="btn btn-small btn-danger" onclick="deleteShot(${posIdx}, ${shotIdx})">üóëÔ∏è</button>
                        </div>
                        <div class="shot-info">
                            <div class="shot-data">
                                <div class="shot-label">Distanza</div>
                                <div class="shot-value">${colpo.distanza}m</div>
                            </div>
                            <div class="shot-data">
                                <div class="shot-label">UP</div>
                                <div class="shot-value">${colpo.U}</div>
                            </div>
                            <div class="shot-data">
                                <div class="shot-label">WIND</div>
                                <div class="shot-value">${colpo.W}</div>
                            </div>
                        </div>
                    `;
                    shotsDiv.appendChild(shotCard);
                });
            });
        }

        function addShot(posIdx) {
            const distanza = prompt('Distanza (metri):');
            if (!distanza) return;
            const U = prompt('Correzione UP:');
            if (U === null) return;
            const W = prompt('Correzione WIND:');
            if (W === null) return;

            currentDrill.posizioni[posIdx].colpi.push({
                n: currentDrill.posizioni[posIdx].colpi.length + 1,
                distanza: parseFloat(distanza),
                U: parseFloat(U),
                W: parseFloat(W)
            });
            renderPositions();
        }

        function deletePosition(idx) {
            if (!confirm('Eliminare questa posizione?')) return;
            currentDrill.posizioni.splice(idx, 1);
            renderPositions();
        }

        function deleteShot(posIdx, shotIdx) {
            if (!confirm('Eliminare questo colpo?')) return;
            currentDrill.posizioni[posIdx].colpi.splice(shotIdx, 1);
            // Rinumera i colpi
            currentDrill.posizioni[posIdx].colpi.forEach((c, i) => c.n = i + 1);
            renderPositions();
        }

        function saveDrill() {
            const nome = document.getElementById('drillName').value.trim();
            const profilo = document.getElementById('drillProfile').value;

            if (!nome || !profilo) {
                alert('Compila nome e profilo!');
                return;
            }

            currentDrill.nome = nome;
            currentDrill.profilo = profilo;

            const index = drills.findIndex(d => d.id === currentDrill.id);
            if (index >= 0) {
                drills[index] = currentDrill;
            } else {
                drills.push(currentDrill);
            }

            Storage.saveDrills(drills);
            loadSavedDrills();
            cancelDrillEdit();
        }

        function deleteDrill(id) {
            if (!confirm('Eliminare questo esercizio?')) return;
            drills = drills.filter(d => d.id !== id);
            Storage.saveDrills(drills);
            loadSavedDrills();
        }

        function cancelDrillEdit() {
            document.getElementById('drillEditor').style.display = 'none';
            currentDrill = null;
        }

        async function sendDrill(drillId) {
            const drill = drills.find(d => d.id === drillId);
            if (!drill) return;

            const data = JSON.stringify(drill);
            const success = await sendCommand(`DRILL:${data}`);
            if (success) {
                alert('‚úÖ Esercizio inviato al dispositivo!');
            }
        }

        // ==========================================
        // EXPORT FUNCTIONS
        // ==========================================

        window.exportDrillImage = (drillId) => {
            const drill = drills.find(d => d.id === drillId);
            if (!drill) return;
            
            const profile = profiles.find(p => p.id === drill.profilo);
            const profileName = profile ? profile.nome : 'Nessun profilo';
            
            const defaultName = drill.nome.replace(/\s+/g, '_').substring(0, 30);
            const fileName = prompt('Nome file PNG:', defaultName);
            if (!fileName) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = 264;
            canvas.height = 176;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, 264, 176);
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'left';
            
            let y = 10;
            ctx.font = 'bold 12px monospace';
            ctx.fillText('RANGE CARD', 85, y);
            y += 12;
            
            ctx.font = '10px monospace';
            const titleLines = drill.nome.match(/.{1,30}/g) || [drill.nome];
            titleLines.forEach(line => {
                ctx.fillText(line, 5, y);
                y += 10;
            });
            
            y += 2;
            ctx.fillRect(5, y, 254, 1);
            y += 5;
            
            ctx.font = '8px monospace';
            ctx.fillText(`Profilo: ${profileName.substring(0, 35)}`, 5, y);
            y += 10;
            ctx.fillText(`Data: ${new Date().toLocaleDateString('it-IT')}`, 5, y);
            y += 12;
            
            drill.posizioni.forEach((pos, posIdx) => {
                if (y > 160) return;
                
                ctx.font = 'bold 9px monospace';
                ctx.fillText(pos.nome.substring(0, 30), 5, y);
                y += 10;
                
                ctx.font = '8px monospace';
                pos.colpi.forEach((colpo, idx) => {
                    if (y > 165 || idx >= 8) return;
                    
                    const dist = String(colpo.distanza).padStart(4, ' ');
                    const u = colpo.U.toFixed(1).padStart(4, ' ');
                    const w = colpo.W.toFixed(1).padStart(4, ' ');
                    const line = `#${colpo.n} ${dist}m U:${u} W:${w}`;
                    
                    ctx.fillText(line, 10, y);
                    y += 9;
                });
                
                y += 3;
            });
            
            ctx.font = 'bold 8px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('SHOOTING-LABS', 132, 170);
            
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName}.png`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert(`üì∏ Immagine salvata!\n\nNome: ${fileName}.png\nRisoluzione: 264x176px\n\n‚úÖ Apri con Note o altra app\n‚úÖ Invia a Waveshare e-Paper`);
            });
        };

        window.exportDrill = (drillId) => {
            const drill = drills.find(d => d.id === drillId);
            if (!drill) return;
            
            const profile = profiles.find(p => p.id === drill.profilo);
            const profileName = profile ? profile.nome : 'Nessun profilo';
            const unit = profile ? profile.unita : 'MIL';
            
            let text = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            text += `    RANGE CARD - ${drill.nome.toUpperCase()}\n`;
            text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            text += `Profilo: ${profileName}\n`;
            text += `Unit√†: ${unit}\n`;
            text += `Data: ${new Date().toLocaleDateString('it-IT')}\n\n`;
            
            drill.posizioni.forEach((pos, idx) => {
                text += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                text += `${pos.nome.toUpperCase()}\n`;
                text += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                
                pos.colpi.forEach(colpo => {
                    const dist = String(colpo.distanza).padStart(4, ' ');
                    const u = String(colpo.U.toFixed(1)).padStart(5, ' ');
                    const w = String(colpo.W.toFixed(1)).padStart(5, ' ');
                    text += `Colpo ${colpo.n}: ${dist}m ‚îÇ U:${u} ${unit} ‚îÇ W:${w} ${unit}\n`;
                });
                text += `\n`;
            });
            
            text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            text += `         BY SHOOTING-LABS\n`;
            text += `        shooting-labs.com\n`;
            text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${drill.nome.replace(/\s+/g, '_')}_RangeCard.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('üì§ Range Card esportata!\n\nApri il file .txt per stampare o visualizzare su Waveshare e-Paper.');
        };

        document.getElementById('previewDrillBtn').onclick = () => {
            if (!currentDrill || currentDrill.posizioni.length === 0) {
                alert('Aggiungi prima almeno una posizione!');
                return;
            }
            
            const nome = document.getElementById('drillName').value.trim() || 'Nuovo Esercizio';
            const profileId = document.getElementById('drillProfile').value;
            const profile = profiles.find(p => p.id === profileId);
            const profileName = profile ? profile.nome : 'Nessun profilo';
            
            let preview = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            preview += `RANGE CARD\n`;
            preview += `${nome.toUpperCase()}\n`;
            preview += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            preview += `Profilo: ${profileName}\n\n`;
            
            currentDrill.posizioni.forEach(pos => {
                preview += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                preview += `${pos.nome.toUpperCase()}\n`;
                preview += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                
                if (pos.colpi.length === 0) {
                    preview += `(Nessun colpo)\n\n`;
                } else {
                    pos.colpi.forEach(c => {
                        preview += `#${c.n}: ${c.distanza}m ‚Üí U:${c.U} W:${c.W}\n`;
                    });
                    preview += `\n`;
                }
            });
            
            alert(preview);
        };

        function exportBackup() {
            const backup = {
                version: '1.0',
                date: new Date().toISOString(),
                profiles: Storage.getProfiles(),
                drills: Storage.getDrills()
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ZeroTime_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('üì§ Backup esportato!');
        }

        function importBackup() {
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const backup = JSON.parse(event.target.result);
                    
                    if (!backup.profiles || !backup.drills) {
                        throw new Error('File backup non valido');
                    }
                    
                    if (confirm('‚ö†Ô∏è Importare il backup? Questo sovrascriver√† tutti i dati attuali!')) {
                        Storage.saveProfiles(backup.profiles);
                        Storage.saveDrills(backup.drills);
                        
                        profiles = backup.profiles;
                        drills = backup.drills;
                        loadProfileList();
                        loadSavedDrills();
                        
                        alert('‚úÖ Backup importato con successo!');
                    }
                } catch (error) {
                    alert('‚ùå Errore: File backup non valido!');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        };

        // ==========================================
        // PWA INSTALL
        // ==========================================
        
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        document.getElementById('installPrompt').onclick = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Install outcome: ${outcome}`);
            deferredPrompt = null;
            document.getElementById('installPrompt').classList.remove('show');
        };

        // ==========================================
        // INIT
        // ==========================================
        
        window.onload = () => {
            loadProfileList();
            loadSavedDrills();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('‚úÖ Service Worker registrato'))
                    .catch(err => console.error('‚ùå Service Worker errore:', err));
            }
            
            console.log('üéØ ZERO TIME - Sistema completo operativo!');
        };
    </script>
</body>
</html>
